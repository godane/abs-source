# $Id: PKGBUILD 9201 2010-01-24 18:27:40Z ibiru $
# Maintainer: Ronald van Haren <ronald.archlinux.org>
# Contributor: Alessio 'mOLOk' Bolognino <themolok@gmail.com>
# Contributor: Jack (nim901@gmail.com)

pkgname=flock
pkgver=2.5.6
pkgrel=1
pkgdesc="A free, easy-to-use web browser built on Mozilla technologies." 
url="http://www.flock.com"
arch=('i686' 'x86_64')
license=('MPL' 'GPL')
depends=('gtk2>=2.18.6' 'dbus-glib' 'libxt' 'nss' 'startup-notification' 'libjpeg>=8' 'desktop-file-utils')
makedepends=('cvs' 'subversion' 'clucene' "java-environment=6" 'zip' 'python' 'libidl2')
install=flock.install

source=(http://dev.archlinux.org/~ronald/source/$pkgname-$pkgver-source.tar.bz2
 	mozconfig
	100-system-hunspell-corrections.patch
	fix-mozilla-launcher.patch
	mozilla-ps-pdf-simplify-operators.patch
	fix_lucene_path.diff
        flockbrowser
	flock.desktop
	libpng14.patch)
md5sums=('091782bb06947840d0234eea73df9b1d' '7642ee43b17138fe5f08efbdf0c0ff11'
         '5efd6772ed0ecf8eddec5d5650191d3c' '63eee2d1da3b43c9d604f2253f242f40'
         '13dca58c04e62a8916691c63c5c492a0' '3293f048e42a633f6a5834bec2fb49f5'
         '51878eff2d60fa3d26e6c05f519f0435' '35702afdbc8575fdd0a4344f54db5246'
	 '5f2234e9dff5319ac14c9481db141c08')

build() {

cd ${srcdir}/${pkgname}-${pkgver}/mozilla/${pkgname}/base/lucene/src
patch -p0 < ${srcdir}/fix_lucene_path.diff || return 1

cd ${srcdir}/${pkgname}-${pkgver}/mozilla
cp -f ${srcdir}/mozconfig .mozconfig

# xulrunner upstream patch. Still not applied
patch -Np1 -i ${srcdir}/mozilla-ps-pdf-simplify-operators.patch || return 1

# fix build with system hunspell - gentoo
patch -Np0 -i ${srcdir}/100-system-hunspell-corrections.patch || return 1

#libpng 1.4.0
patch -Np2 -i ${srcdir}/libpng14.patch || return 1

sed "s/#CFLAGS#/${CFLAGS}/g" ${srcdir}/mozconfig >.mozconfig || return 1

./configure
make || return 1
make DESTDIR=${pkgdir} install || return 1

# moving stuff

mv ${pkgdir}/usr/lib/${pkgname}-${pkgver} ${pkgdir}/usr/lib/${pkgname} || return 1
mv ${pkgdir}/usr/bin/${pkgname} ${pkgdir}/usr/lib/${pkgname}/${pkgname} || return 1

# removing useless folders
rm -rf ${pkgdir}/usr/{bin,share,include} || return 1
rm -rf ${pkgdir}/usr/lib/{$pkgname-devel-$pkgver,pkgconfig} || return 1
rm -rf ${pkgdir}/usr/lib/${pkgname}/{init.d,install} || return 1

# installing icons and desktop files
install -Dm644 ${pkgdir}/usr/lib/flock/icons/mozicon128.png \
	${pkgdir}/usr/share/pixmaps/flock.png || return 1
install -Dm644 ${srcdir}/flock.desktop \
	${pkgdir}/usr/share/applications/flock.desktop || return 1
install -Dm755 ${srcdir}/flockbrowser \
	${pkgdir}/usr/bin/flockbrowser || return 1
}
